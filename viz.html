<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="d3.js"></script>
<style>
  html{
    height: 100%;
    overflow: hidden;
  }
  body {
    font-family: sans-serif;
    height: inherit;
    margin: 0;
  }

  #refes{
    position: absolute;
    bottom: 20px;
    left: 500px;
    max-height: 300px;
    overflow: auto;
  }

  span.ref-color {
      width: 10px;
      height: 12px;
      margin-right: 5px;
      display: inline-block;
  }
  aside {
    position: absolute;
    left: 500px;
    top: 20px;
    font-size: 18px;
    width: 470px;
  }
</style>
<aside>
  <label for="burbuja">Burbuja:</label>
  <select id="burbuja">
    <option selected="true" value="organismo_informante">organismo_informante</option>
    <option value="estado">estado</option>
    <option value="forma_del_pedido">forma_del_pedido</option>
    <option value="punto_de_ingreso">punto_de_ingreso</option>
    <option value="sector_al_que_se_dirige_la_solicitud">sector_al_que_se_dirige_la_solicitud</option>
    <option value="perfil_del_solicitante">perfil_del_solicitante</option>
    <option value="rubro_de_solicitud_de_informacion">rubro_de_solicitud_de_informacion</option>
    <option value="sector_al_que_derivo_el_enlace_dentro_del_organismo">sector_al_que_derivo_el_enlace_dentro_del_organismo</option>
    <option value="plazo_en_el_que_se_contesto_la_solicitud">plazo_en_el_que_se_contesto_la_solicitud</option>
    <option value="forma_de_aviso_de_uso_de_la_prorroga_al_solicitante">forma_de_aviso_de_uso_de_la_prorroga_al_solicitante</option>
    <option value="condicion_de_respuesta">condicion_de_respuesta</option>
    <option value="cargo_del_funcionario_que_firma_la_entrega_de_la_informacion">cargo_del_funcionario_que_firma_la_entrega_de_la_informacion</option>
  </select>

  <label for="torta">Torta:</label>
  <select id="torta">
    <option value="organismo_informante">organismo_informante</option>
    <option selected="true" value="estado">estado</option>
    <option value="forma_del_pedido">forma_del_pedido</option>
    <option value="punto_de_ingreso">punto_de_ingreso</option>
    <option value="sector_al_que_se_dirige_la_solicitud">sector_al_que_se_dirige_la_solicitud</option>
    <option value="perfil_del_solicitante">perfil_del_solicitante</option>
    <option value="rubro_de_solicitud_de_informacion">rubro_de_solicitud_de_informacion</option>
    <option value="sector_al_que_derivo_el_enlace_dentro_del_organismo">sector_al_que_derivo_el_enlace_dentro_del_organismo</option>
    <option value="plazo_en_el_que_se_contesto_la_solicitud">plazo_en_el_que_se_contesto_la_solicitud</option>
    <option value="forma_de_aviso_de_uso_de_la_prorroga_al_solicitante">forma_de_aviso_de_uso_de_la_prorroga_al_solicitante</option>
    <option value="condicion_de_respuesta">condicion_de_respuesta</option>
    <option value="cargo_del_funcionario_que_firma_la_entrega_de_la_informacion">cargo_del_funcionario_que_firma_la_entrega_de_la_informacion</option>
  </select>
  <button>Ver</button>
</aside>
<div id="refes"></div>
<script>
//Preparar layout
var bubble = d3.layout.pack()
    .sort(null)
    .size([500, 500])
    .padding(20);

var svg = d3.select("body")
    .append("svg")
    .style("width", '100%')
    .style("height", '100%');

//Get .csv
d3.csv("acceso-informacion-publica.csv", function(csv_data) {

  document.querySelector('aside button').addEventListener('click', function(e){
    var que_torta = document.getElementById('torta').value;
    var que_burbuja = document.getElementById('burbuja').value;
    Graficar(que_burbuja, que_torta);
  });

  function Graficar(burbuja, torta){
    document.querySelector('svg').innerHTML = '';
    //Parsear la data
    var xMinisterios = [];
    csv_data.forEach(function(v){
      if (typeof xMinisterios[v[burbuja]] != 'object') {
        xMinisterios[v[burbuja]] = [];
      }
      if (typeof xMinisterios[v[burbuja]][v[torta]] != 'object') {
        xMinisterios[v[burbuja]][v[torta]] = [];
      }
      xMinisterios[v[burbuja]][v[torta]].push(v);
    });

    //console.log(xMinisterios)

    //Separar lo que se va a graficar
    var data_pa_graficar = Object.keys(xMinisterios)
      .map(function(m){
        return { 
          item:m,
          values: Object.keys(xMinisterios[m])
            .map(function(v){
              return { label: v, val:xMinisterios[m][v].length };
            })
        }
      }).map(function(v){
        v.value = v.values
          .map(function(v){return v.val})
          .reduce(function(a, b){ return a + b; });
          return v;
      });

    //Armar grafico de burbujas
    var burbujas = svg
      .append("g")
      .selectAll("svg")
      .data( 
        bubble
          .nodes({children:data_pa_graficar})
          .filter(function(d) { return !d.children; })
      );

    //Labels
    var text = d3
      .select("svg")
      .append("text")   
      .style("opacity", 0);

    //Graficar cada burbuja
    burbujas
      .enter()
      .append("g")      
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y+ ")"; })
      .on("mouseover", function(d) {      
        text.transition()        
          .duration(200)      
          .style("opacity", 1);
        text.text(d.item)  
          .attr("x", "500px")     
          .attr("y", "100px");    
        })                  
      .on("mouseout", function(d) {       
        text.transition()        
          .duration(500)      
          .style("opacity", 0);   
      });

    //Referencias

    var referencias = []
      .concat.apply([], 
        Object.keys(xMinisterios)
          .map(function(v){ return Object.keys(xMinisterios[v]) }))
      .filter(function(v,i,a){ return a.indexOf(v) === i });

    var color = d3.scale.category20()
    
    var refes_div = document.getElementById('refes');
    refes_div.innerHTML = "";
    referencias.forEach(function(v){
      refes_div.innerHTML += 
        "<div class='ref'>"+
          "<span class='ref-color' style='background:"+color(v)+";'></span>"+
          "<span class='ref-label'>" +v+ "</span>"+
        "</div>";
    });

    //Tortas
    var arc = d3.svg.arc().innerRadius(0);
    var pie = d3.layout.pie();
    burbujas
      .selectAll("g.torta")
      .data(function(d) {
        return pie( d.values.map(function(v){return v.val}) )
          .map(function(m) { 
            m.lbl = d.values.map(function(v){return v.label});
            m.r = d.r; 
            return m; 
          });
      })
      .enter()
      .append("g")
      .attr("class", "torta")
      .append("path")
      .attr("d", function(d) {
        arc.outerRadius(d.r);
        return arc(d);
      })
      .style("fill", function(d, i) {
        return color(d.lbl[i]); 
      });
  };
  Graficar('organismo_informante', 'estado');
});
</script>